from flask import Flask, jsonify, request
from models import async_session, Giveaway, Channel
import asyncio

app = Flask(__name__)

@app.route('/api/giveaway/<int:giveaway_id>', methods=['GET'])
async def get_giveaway(giveaway_id):
    async with async_session() as session:
        giveaway = await session.get(Giveaway, giveaway_id, options=[selectinload(Giveaway.channels)])
        if not giveaway:
            return jsonify({'status': 'error', 'message': 'Розыгрыш не найден'})
        
        return jsonify({
            'status': 'success',
            'data': {
                'id': giveaway.id,
                'name': giveaway.name,
                'description': giveaway.description,
                'is_active': giveaway.is_active,
                'max_participants': giveaway.max_participants,
                'participants': giveaway.participants,
                'channels': [{
                    'id': channel.tg_id,
                    'title': channel.title,
                    'invite_link': channel.invite_link
                } for channel in giveaway.channels],
                'winner_id': giveaway.winner_id
            }
        })

@app.route('/api/participate', methods=['POST'])
async def participate():
    data = request.json
    giveaway_id = data['giveaway_id']
    user_id = data['user_id']
    
    async with async_session() as session:
        giveaway = await session.get(Giveaway, giveaway_id)
        if not giveaway or not giveaway.is_active:
            return jsonify({'status': 'error', 'message': 'Розыгрыш завершен'})
        
        if giveaway.participants >= giveaway.max_participants:
            return jsonify({'status': 'error', 'message': 'Лимит участников достигнут'})
        
        existing = await session.scalar(
            select(GiveawayParticipant).where(
                GiveawayParticipant.giveaway_id == giveaway_id,
                GiveawayParticipant.user_id == user_id
            )
        )
        
        if existing:
            return jsonify({'status': 'error', 'message': 'Вы уже участвуете'})
        
        session.add(GiveawayParticipant(giveaway_id=giveaway_id, user_id=user_id))
        await session.commit()
        return jsonify({'status': 'success'})

if __name__ == '__main__':
    app.run(port=5000)
