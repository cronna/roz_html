<!DOCTYPE html>
<html>
<head>
    <title>Giveaway</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        .container { padding: 20px; text-align: center; }
        .hidden { display: none; }
        .channel-list { list-style: none; padding: 0; }
        .channel-item { margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div id="participateSection">
            <button id="participateBtn" onclick="handleParticipate()">–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å</button>
        </div>
        
        <div id="channelsSection" class="hidden">
            <h3>–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –∫–∞–Ω–∞–ª—ã:</h3>
            <ul class="channel-list" id="channelList"></ul>
            <button onclick="checkSubscriptions()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
        </div>

        <div id="successMessage" class="hidden">
            <h3>–í—ã —É—Å–ø–µ—à–Ω–æ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ! üéâ</h3>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        let giveawayId = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        tg.expand();
        tg.ready();

        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—É—Å–∫–∞
        const initData = tg.initDataUnsafe;
        const startParam = tg.initParams;
        giveawayId = startParam.split('=')[1];

        async function loadGiveawayData() {
            try {
                const response = await fetch(`/api/giveaway/${giveawayId}`, {
                    headers: {
                        'X-Telegram-Init-Data': JSON.stringify(initData)
                    }
                });
                
                const data = await response.json();
                
                if (data.isParticipant) {
                    showSuccessMessage();
                } else if (data.channels) {
                    renderChannels(data.channels);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function handleParticipate() {
            document.getElementById('participateSection').classList.add('hidden');
            document.getElementById('channelsSection').classList.remove('hidden');
        }

        function renderChannels(channels) {
            const list = document.getElementById('channelList');
            channels.forEach(channel => {
                const li = document.createElement('li');
                li.className = 'channel-item';
                li.innerHTML = `
                    <a href="${channel.invite_link}" target="_blank">${channel.title}</a>
                `;
                list.appendChild(li);
            });
        }

        async function checkSubscriptions() {
            try {
                const response = await fetch('/api/check-subscriptions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Telegram-Init-Data': JSON.stringify(initData)
                    },
                    body: JSON.stringify({ giveawayId })
                });

                const result = await response.json();
                
                if (result.success) {
                    showSuccessMessage();
                } else {
                    alert('–ü–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ –≤—Å–µ –∫–∞–Ω–∞–ª—ã!');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function showSuccessMessage() {
            document.getElementById('channelsSection').classList.add('hidden');
            document.getElementById('successMessage').classList.remove('hidden');
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadGiveawayData();
    </script>
</body>
</html>
