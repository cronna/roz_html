<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£—á–∞—Å—Ç–∏–µ –≤ —Ä–æ–∑—ã–≥—Ä—ã—à–µ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        h1 {
            color: #4CAF50;
            text-align: center;
        }
        .channel-list {
            margin: 20px 0;
        }
        .channel-item {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .channel-name {
            flex-grow: 1;
            margin-left: 10px;
        }
        .check-button {
            display: block;
            width: 100%;
            padding: 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            margin-top: 20px;
        }
        .check-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .winner-message {
            text-align: center;
            padding: 40px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container" id="app">
        <div v-if="loading" class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        
        <div v-if="!loading && giveaway">
            <div v-if="giveaway.winner">
                <div class="winner-message">
                    <h2>üéâ –†–æ–∑—ã–≥—Ä—ã—à –∑–∞–≤–µ—Ä—à–µ–Ω!</h2>
                    <p>–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: @{{ giveaway.winner.username }}</p>
                </div>
            </div>
            
            <div v-else>
                <h1>{{ giveaway.name }}</h1>
                <p>{{ giveaway.description }}</p>
                
                <div class="channel-list" v-if="channels.length > 0">
                    <div class="channel-item" v-for="channel in channels" :key="channel.id">
                        <a :href="channel.invite_link" target="_blank" style="text-decoration: none; color: inherit;">
                            <span>üì¢</span>
                            <span class="channel-name">{{ channel.title }}</span>
                        </a>
                    </div>
                </div>
                
                <button class="check-button" @click="checkSubscription" :disabled="isChecking">
                    {{ isChecking ? '–ü—Ä–æ–≤–µ—Ä—è–µ–º...' : '‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É' }}
                </button>
                
                <div v-if="error" style="color: red; margin-top: 10px;">{{ error }}</div>
                <div v-if="success" style="color: green; margin-top: 10px;">{{ success }}</div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    loading: true,
                    giveaway: null,
                    channels: [],
                    isChecking: false,
                    error: null,
                    success: null
                }
            },
            async mounted() {
                const params = new URLSearchParams(window.location.search);
                const giveawayId = params.get('giveaway_id');
                
                try {
                    const response = await fetch(`/api/giveaway/${giveawayId}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.giveaway = data.giveaway;
                        this.channels = data.channels;
                    } else {
                        this.error = data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
                    }
                } catch (e) {
                    this.error = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
                } finally {
                    this.loading = false;
                }
            },
            methods: {
                async checkSubscription() {
                    this.isChecking = true;
                    this.error = null;
                    this.success = null;
                    
                    try {
                        const params = new URLSearchParams(window.location.search);
                        const giveawayId = params.get('giveaway_id');
                        
                        const response = await fetch('/api/participate', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                giveaway_id: giveawayId,
                                user: Telegram.WebApp.initData
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            this.success = 'üéâ –í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ —Ä–æ–∑—ã–≥—Ä—ã—à—É!';
                            Telegram.WebApp.close();
                        } else {
                            this.error = data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–æ–¥–ø–∏—Å–∫–∏';
                        }
                    } catch (e) {
                        this.error = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
                    } finally {
                        this.isChecking = false;
                    }
                }
            }
        }).mount('#app');
        
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
    </script>
</body>
</html>
